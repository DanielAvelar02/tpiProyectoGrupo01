{% extends 'base_menu.html' %}

{% block menu_title %}
  Pagar
{% endblock %}

{% block menu_content %}
<h1>Detalles de Pago</h1>
  <main class="container d-flex justify-content-center align-items-center" style="min-height: 100vh; margin-top: -50px;">
    <div class="row shadow rounded p-4 w-100 bg-white" style="max-width: 1200px;">
      <!-- Mapa -->
      <div class="col-md-6 text-center">
        <input type="text" id="direccion" class="form-control mb-3" placeholder="Ingresa tu dirección">
        <button id="buscarDireccion" class="btn btn-primary mb-3">Buscar Dirección</button>
        <div id="map" class="border rounded mb-3" style="width: 100%; height: 300px;"></div>
        <p>Selecciona tu ubicación</p>
      </div>
      <!-- Formulario -->
      <div class="col-md-6">
        <h3>Información</h3>
        <form id="pagoForm">
          <div class="mb-3">
            <label for="nombre" class="form-label">Nombre:</label>
            <input type="text" id="nombre" name="nombre" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="apellido" class="form-label">Apellido:</label>
            <input type="text" id="apellido" name="apellido" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="telefono" class="form-label">Teléfono:</label>
            <input type="tel" id="telefono" name="telefono" class="form-control" required>
          </div>

          <button type="submit" class="btn btn-primary w-100 mt-3">Pagar</button>
        </form>
      </div>
    </div>
  </main>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Inicializar el mapa centrado en San Salvador
    const map = L.map('map').setView([13.692940, -89.218191], 13); // Coordenadas de San Salvador

    // Agregar el mapa base desde OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Agregar un marcador inicial en San Salvador
    const marker = L.marker([13.692940, -89.218191], { draggable: true }).addTo(map);

    // Escuchar eventos de arrastre del marcador
    marker.on('dragend', function (e) {
        const position = marker.getLatLng();
        alert(`Ubicación seleccionada:\nLat: ${position.lat}\nLng: ${position.lng}`);
    });

    // Obtener la ubicación actual del usuario
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const latLng = [position.coords.latitude, position.coords.longitude];
            map.setView(latLng, 13);
            marker.setLatLng(latLng);
        }, function() {
            alert('No se pudo obtener la ubicación actual.');
        });
    } else {
        alert('La geolocalización no es soportada por este navegador.');
    }

    // Buscar dirección y actualizar el mapa
    document.getElementById('buscarDireccion').addEventListener('click', function() {
        const direccion = document.getElementById('direccion').value;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${direccion}`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    const latLng = [data[0].lat, data[0].lon];
                    map.setView(latLng, 13);
                    marker.setLatLng(latLng);
                } else {
                    alert('No se pudo encontrar la dirección.');
                }
            })
            .catch(error => {
                console.error('Error al buscar la dirección:', error);
                alert('Ocurrió un error al buscar la dirección.');
            });
    });

    // Redirigir a la página de seguimiento del pedido al enviar el formulario
    document.getElementById('pagoForm').addEventListener('submit', function(event) {
        event.preventDefault();
        window.location.href = "{% url 'seguimiento_pedido' %}";
    });
  </script>
{% endblock %}
